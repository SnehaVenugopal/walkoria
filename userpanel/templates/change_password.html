{% extends "base_userpanel.html" %}

{% block title %}Change Password - Walkoria{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'profile' %}">My Profile</a></li>
        <li class="breadcrumb-item active">Change Password</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="content-card">
    <h2 class="page-title">Change Password</h2>
    
    <div class="row justify-content-center">
        <div class="col-md-8">
            <form method="POST" novalidate>
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="id_old_password" class="form-label">Current Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-control {% if form.old_password.errors %}is-invalid{% endif %}" 
                               id="id_old_password" name="old_password" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('id_old_password', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.old_password.errors %}
                        <div class="error-message">{{ form.old_password.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="id_new_password" class="form-label">New Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-control {% if form.new_password.errors %}is-invalid{% endif %}" 
                               id="id_new_password" name="new_password" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('id_new_password', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.new_password.errors %}
                        <div class="error-message">{{ form.new_password.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted">
                        Password must be at least 8 characters long and cannot contain spaces.
                    </small>
                </div>
                
                <div class="mb-4">
                    <label for="id_confirm_password" class="form-label">Confirm New Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-control {% if form.confirm_password.errors %}is-invalid{% endif %}" 
                               id="id_confirm_password" name="confirm_password" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('id_confirm_password', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.confirm_password.errors %}
                        <div class="error-message">{{ form.confirm_password.errors.0 }}</div>
                    {% endif %}
                    {% if form.non_field_errors %}
                        <div class="error-message">{{ form.non_field_errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                    <a href="{% url 'profile' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.password-input-container {
    position: relative;
}

.password-toggle-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
    z-index: 10;
}

.password-toggle-btn:hover {
    color: var(--primary-color);
}

.password-toggle-btn:focus {
    outline: none;
}

.form-actions {
    border-top: 1px solid #eee;
    padding-top: 20px;
    margin-top: 30px;
}

.security-tips {
    background-color: #f8f9fa;
    border-left: 4px solid var(--primary-color);
    padding: 20px;
    margin-top: 30px;
    border-radius: 0 8px 8px 0;
}

.security-tips h5 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.security-tips ul {
    margin: 0;
    padding-left: 20px;
}

.security-tips li {
    margin-bottom: 8px;
    color: #666;
}
</style>

<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Password strength indicator
document.getElementById('id_new_password').addEventListener('input', function() {
    const password = this.value;
    const strengthIndicator = document.getElementById('password-strength');
    
    if (password.length === 0) {
        if (strengthIndicator) strengthIndicator.remove();
        return;
    }
    
    let strength = 0;
    let feedback = [];
    
    if (password.length >= 8) strength++;
    else feedback.push('At least 8 characters');
    
    if (/[a-z]/.test(password)) strength++;
    else feedback.push('Lowercase letter');
    
    if (/[A-Z]/.test(password)) strength++;
    else feedback.push('Uppercase letter');
    
    if (/[0-9]/.test(password)) strength++;
    else feedback.push('Number');
    
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    else feedback.push('Special character');
    
    const colors = ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#28a745'];
    const labels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
    
    let existingIndicator = document.getElementById('password-strength');
    if (!existingIndicator) {
        existingIndicator = document.createElement('div');
        existingIndicator.id = 'password-strength';
        existingIndicator.className = 'mt-2';
        this.parentNode.appendChild(existingIndicator);
    }
    
    existingIndicator.innerHTML = `
        <div class="progress" style="height: 6px;">
            <div class="progress-bar" style="width: ${(strength/5)*100}%; background-color: ${colors[strength-1] || colors[0]};"></div>
        </div>
        <small style="color: ${colors[strength-1] || colors[0]};">${labels[strength-1] || labels[0]}</small>
    `;
});
</script>
{% endblock %}
