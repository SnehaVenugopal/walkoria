{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Coupon Management | Walkoria{% endblock %}

{% block page_title %}Coupon{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/coupon_management.css' %}">
<style>
    /* Improved form layout */
    #couponForm {
        padding: 20px 25px 10px;
    }
    .form-section-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #adb5bd;
        margin: 18px 0 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #f1f1f1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Coupon Header -->
<div class="management-header">
    <h2>Coupon Management</h2>
    <button class="btn-add" onclick="openAddModal()">
        <i class="fas fa-plus"></i> Add Coupon
    </button>
</div>

<!-- Search Section -->
<div class="search-section">
    <form method="GET" class="search-form">
        <input type="text" name="search" class="search-input" placeholder="Search coupons..." value="{{ request.GET.search }}">
        <button type="submit" class="btn-search">
            <i class="fas fa-search"></i> Search
        </button>
        {% if request.GET.search %}
        <a href="{% url 'coupon' %}" class="btn-clear">
            <i class="fas fa-times"></i> Clear
        </a>
        {% endif %}
    </form>
</div>

<!-- Coupon Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>S.NO</th>
                <th>CODE</th>
                <th>DISCOUNT</th>
                <th>MIN CART</th>
                <th>VALID PERIOD</th>
                <th>USAGE</th>
                <th>LIST / UNLIST</th>
                <th>ACTIONS</th>
            </tr>
        </thead>
        <tbody>
            {% for coupon in coupons %}
            <tr data-coupon-id="{{ coupon.id }}">
                <td>{{ forloop.counter }}</td>
                <td><span class="coupon-code-badge">{{ coupon.code }}</span></td>
                <td>
                    {% if coupon.discount_type == 'percent' %}
                        {{ coupon.discount_value }}%
                    {% else %}
                        Rs.{{ coupon.discount_value }}
                    {% endif %}
                </td>
                <td>Rs.{{ coupon.min_cart_value|default:"0" }}</td>
                <td>{{ coupon.start_date|date:"d M Y" }} - {{ coupon.end_date|date:"d M Y" }}</td>
                <td>{{ coupon.max_usage }} / {{ coupon.max_usage_per_user }} per user</td>
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" class="toggle-input"
                               {% if coupon.active %}checked{% endif %}
                               data-coupon-id="{{ coupon.id }}">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td>
                    <div class="action-btns">
                        <button class="btn-edit" onclick="editCoupon({{ coupon.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" onclick="deleteCoupon({{ coupon.id }}, '{{ coupon.code }}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="empty-message">
                    {% if request.GET.search %}
                        No coupons found for "{{ request.GET.search }}"
                    {% else %}
                        No coupons found
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if coupons.has_other_pages %}
    <div class="pagination">
        {% if coupons.has_previous %}
            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-link">First</a>
            <a href="?page={{ coupons.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-link">Previous</a>
        {% endif %}

        {% for num in coupons.paginator.page_range %}
            {% if coupons.number == num %}
                <span class="page-link active">{{ num }}</span>
            {% elif num > coupons.number|add:'-3' and num < coupons.number|add:'3' %}
                <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-link">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if coupons.has_next %}
            <a href="?page={{ coupons.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-link">Next</a>
            <a href="?page={{ coupons.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-link">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- ========= ADD / EDIT COUPON MODAL ========= -->
<div id="couponModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Coupon</h3>
            <button type="button" class="modal-close-btn" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="couponForm">
            <input type="hidden" id="couponId" name="coupon_id">

            <!-- Basic Info -->
            <p class="form-section-title">Basic Information</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Coupon Code <span class="required">*</span></label>
                    <input type="text" id="couponCode" name="code" placeholder="e.g. SAVE20" required>
                </div>
                <div class="form-group">
                    <label>Discount Type <span class="required">*</span></label>
                    <select id="discountType" name="discount_type" required>
                        <option value="percent">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (₹)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Discount Value <span class="required">*</span></label>
                    <input type="number" id="discountValue" name="discount_value" placeholder="e.g. 10 for 10%" required min="1">
                </div>
                <div class="form-group">
                    <label>Min Cart Value <span class="required">*</span></label>
                    <input type="number" id="minCartValue" name="min_cart_value" placeholder="e.g. 500" required min="1">
                </div>
            </div>

            <!-- Usage Limits -->
            <p class="form-section-title">Usage Limits</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Max Total Uses <span class="required">*</span></label>
                    <input type="number" id="maxUsage" name="max_usage" placeholder="Total times usable" value="1" required min="1">
                </div>
                <div class="form-group">
                    <label>Max Uses Per User <span class="required">*</span></label>
                    <input type="number" id="maxUsagePerUser" name="max_usage_per_user" placeholder="Per user limit" value="1" required min="1">
                </div>
            </div>

            <!-- Validity -->
            <p class="form-section-title">Validity Period</p>
            <div class="form-row">
                <div class="form-group">
                    <label>Start Date <span class="required">*</span></label>
                    <input type="date" id="startDate" name="start_date" required>
                </div>
                <div class="form-group">
                    <label>End Date <span class="required">*</span></label>
                    <input type="date" id="endDate" name="end_date" required>
                </div>
            </div>

            <!-- Description -->
            <p class="form-section-title">Description (Optional)</p>
            <div class="form-row">
                <div class="form-group full-width">
                    <textarea id="description" name="description" placeholder="Brief description shown to users (e.g. 'Get 10% off on orders above ₹500')" rows="2"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-save" id="submitBtn">Save Coupon</button>
            </div>
        </form>
    </div>
</div>

<!-- ========= DELETE CONFIRMATION MODAL ========= -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:30px; min-width:380px; max-width:440px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:14px; border-bottom:1px solid #f1f1f1;">
            <h3 style="margin:0; color:#dc3545; font-size:1.15rem; font-weight:600;">
                <i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Confirm Delete
            </h3>
            <button onclick="closeDeleteModal()" style="background:none; border:none; font-size:20px; cursor:pointer; color:#6c757d; line-height:1; padding:0;">&times;</button>
        </div>
        <p id="deleteModalMessage" style="color:#495057; font-size:15px; margin:0 0 24px; line-height:1.5;"></p>
        <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button onclick="closeDeleteModal()" style="background:#6c757d; color:white; border:none; padding:10px 22px; border-radius:8px; cursor:pointer; font-weight:500; font-size:14px;">Cancel</button>
            <button id="confirmDeleteBtn" style="background:#dc3545; color:white; border:none; padding:10px 22px; border-radius:8px; cursor:pointer; font-weight:500; font-size:14px;">Yes, Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- Date constraints ---
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('startDate');
    const endDateInput   = document.getElementById('endDate');
    startDateInput.min = today;
    endDateInput.min   = today;
    startDateInput.addEventListener('change', function () {
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });

    // --- Coupon form submit (Add / Edit) ---
    document.getElementById('couponForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const couponId = document.getElementById('couponId').value;
        const isEdit   = couponId !== '';
        const formData = {
            code:               document.getElementById('couponCode').value,
            discount_type:      document.getElementById('discountType').value,
            discount_value:     document.getElementById('discountValue').value,
            min_cart_value:     document.getElementById('minCartValue').value,
            max_usage:          document.getElementById('maxUsage').value,
            max_usage_per_user: document.getElementById('maxUsagePerUser').value,
            start_date:         document.getElementById('startDate').value,
            end_date:           document.getElementById('endDate').value,
            description:        document.getElementById('description').value,
            active:             true
        };
        const url = isEdit
            ? `{% url 'edit_coupon' coupon_id=0 %}`.replace('0', couponId)
            : '{% url "add_coupon" %}';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(formData)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Success', data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error', data.message, 'error');
            }
        })
        .catch(() => showAlert('Error', 'An unexpected error occurred', 'error'));
    });

    // --- Toggle list/unlist ---
    document.querySelectorAll('.toggle-input').forEach(toggle => {
        toggle.addEventListener('change', function () {
            const couponId = this.dataset.couponId;
            const checkbox = this;
            fetch(`{% url 'toggle_coupon_status' coupon_id=0 %}`.replace('0', couponId), {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert('Success', data.message, 'success');
                } else {
                    checkbox.checked = !checkbox.checked;
                    showAlert('Error', data.message, 'error');
                }
            })
            .catch(() => {
                checkbox.checked = !checkbox.checked;
                showAlert('Error', 'An unexpected error occurred', 'error');
            });
        });
    });

    // --- Outside click to close ---
    document.getElementById('couponModal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
    document.getElementById('deleteModal').addEventListener('click', function (e) {
        if (e.target === this) closeDeleteModal();
    });

    // --- Escape key ---
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') { closeModal(); closeDeleteModal(); }
    });
});

/* ---- Helpers ---- */

function showAlert(title, message, type) {
    const box = document.createElement('div');
    box.className = `custom-alert ${type}`;
    box.innerHTML = `
        <div class="alert-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <div><strong>${title}</strong><p>${message}</p></div>
        </div>`;
    document.body.appendChild(box);
    setTimeout(() => box.classList.add('show'), 10);
    setTimeout(() => { box.classList.remove('show'); setTimeout(() => box.remove(), 300); }, 3000);
}

function openAddModal() {
    document.getElementById('modalTitle').textContent  = 'Add New Coupon';
    document.getElementById('submitBtn').textContent   = 'Save Coupon';
    document.getElementById('couponForm').reset();
    document.getElementById('couponId').value          = '';
    document.getElementById('couponCode').removeAttribute('readonly');
    document.getElementById('startDate').removeAttribute('readonly');
    document.getElementById('couponModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('couponModal').style.display = 'none';
}

function editCoupon(couponId) {
    fetch(`{% url 'edit_coupon' coupon_id=0 %}`.replace('0', couponId))
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const c = data.coupon;
            document.getElementById('modalTitle').textContent = 'Edit Coupon';
            document.getElementById('submitBtn').textContent  = 'Update Coupon';
            document.getElementById('couponId').value         = c.id;
            document.getElementById('couponCode').value       = c.code;
            document.getElementById('couponCode').setAttribute('readonly', true);
            document.getElementById('discountType').value     = c.discount_type;
            document.getElementById('discountValue').value    = c.discount_value;
            document.getElementById('minCartValue').value     = c.min_cart_value || '';
            document.getElementById('maxUsage').value         = c.max_usage;
            document.getElementById('maxUsagePerUser').value  = c.max_usage_per_user;
            document.getElementById('startDate').value        = c.start_date ? c.start_date.split('T')[0] : '';
            document.getElementById('startDate').setAttribute('readonly', true);
            document.getElementById('endDate').value          = c.end_date   ? c.end_date.split('T')[0]   : '';
            document.getElementById('description').value      = c.description || '';
            document.getElementById('couponModal').style.display = 'flex';
        } else {
            showAlert('Error', data.message, 'error');
        }
    })
    .catch(() => showAlert('Error', 'An unexpected error occurred', 'error'));
}

/* ---- Delete modal ---- */
let _deleteCouponId = null;

function deleteCoupon(couponId, couponCode) {
    _deleteCouponId = couponId;
    document.getElementById('deleteModalMessage').textContent =
        `Are you sure you want to delete coupon "${couponCode}"? This action cannot be undone.`;
    document.getElementById('confirmDeleteBtn').onclick = confirmDeleteCoupon;
    document.getElementById('deleteModal').style.display = 'flex';
}

function confirmDeleteCoupon() {
    if (!_deleteCouponId) return;
    fetch(`{% url 'delete_coupon' coupon_id=0 %}`.replace('0', _deleteCouponId), {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(r => r.json())
    .then(data => {
        closeDeleteModal();
        if (data.success) {
            showAlert('Success', data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error', data.message, 'error');
        }
    })
    .catch(() => { closeDeleteModal(); showAlert('Error', 'An unexpected error occurred', 'error'); });
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    _deleteCouponId = null;
}
</script>
{% endblock %}
