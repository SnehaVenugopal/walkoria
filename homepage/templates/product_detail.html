{% extends "baseuser.html" %}
{% load static %}

{% block title %}{{ product.name }} - Walkoria{% endblock %}

{% block style %}
<style>
    .breadcrumb {
        background: none;
        padding: 20px 0;
    }
    
    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: #6c757d;
    }
    
    .product-gallery {
        position: relative;
    }
    
    .product-image-container {
        position: relative;
        margin-bottom: 20px;
        border-radius: 15px;
        /* Do NOT use overflow:hidden — it clips the magnifier glass */
        background: #f8f9fa;
    }
    
    .product-image {
        width: 100%;
        height: 400px;
        object-fit: contain;
        transition: all 0.3s ease;
    }
    
    .image-nav-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }
    
    .image-nav-button:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .image-nav-button.prev {
        left: 15px;
    }
    
    .image-nav-button.next {
        right: 15px;
    }
    
    .thumbnail-gallery {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
    }
    
    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .thumbnail.active {
        border-color: var(--primary-color);
    }
    
    .thumbnail:hover {
        border-color: var(--secondary-color);
    }
    
    .product-info {
        padding: 20px 0;
    }
    
    .product-info h1 {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }
    
    .product-rating {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .star {
        color: #ffc107;
        font-size: 1.2rem;
    }
    
    .star.empty {
        color: #e9ecef;
    }
    
    .review-count {
        color: #666;
        font-size: 0.95rem;
    }
    
    .sale-price {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    
    .original-price {
        font-size: 1.2rem;
        color: #999;
        text-decoration: line-through;
        margin-bottom: 20px;
    }

    /* Offer type badge */
    .offer-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #fff0f5, #ffe0ec);
        border: 1px solid #ffb3d1;
        border-radius: 20px;
        padding: 6px 14px;
        margin-bottom: 15px;
    }
    .offer-type-badge i {
        color: #ff429d;
        font-size: 0.85rem;
    }
    .offer-type-badge .offer-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #d63384;
    }
    .offer-type-badge .offer-pct-val {
        font-size: 0.85rem;
        font-weight: 700;
        color: #ff429d;
    }
    
    .variant-select {
        margin: 30px 0;
    }
    
    .variant-select .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }
    
    .variant-select .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
    }
    
    .variant-select .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 66, 157, 0.25);
    }
    
    .btn-primary {
        background: var(--gradient-primary);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 66, 157, 0.3);
    }
    
        .wishlist-btn {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        color: #ccc;  /* Gray color for unliked state */
    }
    
    .wishlist-btn i {
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }
    
    .wishlist-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .wishlist-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .out-of-stock {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        font-weight: 600;
    }
    
    .description {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #e9ecef;
    }
    
    .description h5 {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .description p {
        color: #666;
        line-height: 1.6;
    }
    
    .related-products {
        margin-top: 60px;
        padding-top: 40px;
        border-top: 1px solid #e9ecef;
    }
    
    .related-products h2 {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }
    
    .related-product-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: visible;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .related-product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: var(--primary-color);
    }
    
    .related-product-card .card-img-top {
        height: 200px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
        overflow: hidden;
    }
    
    .related-product-card .card-body {
        padding: 20px;
    }
    
    .related-product-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .reviews-section {
        margin-top: 60px;
        padding-top: 40px;
        border-top: 1px solid #e9ecef;
    }
    
    .reviews-section h2 {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }
    
    .review-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .review-author {
        font-weight: 600;
        color: #333;
    }
    
    .review-date {
        color: #666;
        font-size: 0.9rem;
    }
    
    .review-rating {
        margin-bottom: 15px;
    }
    
    .review-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    /* Image Magnifier */
    .img-magnifier-container {
        position: relative;
    }
    .img-magnifier-glass {
        position: absolute;
        border: 2px solid rgba(255,66,157,0.6);
        border-radius: 50%;
        /* CRITICAL: never intercept mouse events — prevents enter/leave flicker */
        pointer-events: none;
        width: 130px;
        height: 130px;
        z-index: 100;
        display: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        background-repeat: no-repeat;
    }
    
    @media (max-width: 768px) {
        .product-info h1 {
            font-size: 1.5rem;
        }
        
        .sale-price {
            font-size: 1.5rem;
        }
        
        .product-image {
            height: 300px;
        }
        
        .thumbnail {
            width: 60px;
            height: 60px;
        }
    }

    /* ── Offer Badge for related products (same as home page) ── */
    @keyframes flower-pop {
        0%, 100% { transform: scale(1); }
        15%      { transform: scale(1.12); }
        30%      { transform: scale(1); }
    }

    .flower-petal {
        position: absolute;
        width: 24px;
        height: 28px;
        background: linear-gradient(135deg, #ff429d 0%, #ff6fb5 100%);
        border-radius: 50%;
        left: 50%;
        bottom: 50%;
        margin-left: -12px;
        transform-origin: center bottom;
    }
    .flower-petal:nth-child(1) { transform: rotate(0deg); }
    .flower-petal:nth-child(2) { transform: rotate(72deg); }
    .flower-petal:nth-child(3) { transform: rotate(144deg); }
    .flower-petal:nth-child(4) { transform: rotate(216deg); }
    .flower-petal:nth-child(5) { transform: rotate(288deg); }

    .offer-text {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    .offer-pct {
        color: #fff;
        font-weight: 800;
        font-size: 0.65rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.25);
    }
    .offer-off {
        color: #fff;
        font-weight: 800;
        font-size: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .comet-orbit {
        position: absolute;
        width: 100%; height: 100%;
        top: 0; left: 0;
        animation: comet-spin 3s linear infinite, comet-fade 3s ease-in-out infinite;
        pointer-events: none;
    }
    .comet-orbit::before {
        content: '';
        position: absolute;
        width: 100%; height: 100%;
        border-radius: 50%;
        background: conic-gradient(from 295deg at 50% 50%, transparent 0deg, rgba(200,200,220,0.04) 10deg, rgba(200,200,220,0.12) 25deg, rgba(255,255,255,0.35) 42deg, rgba(255,255,255,0.7) 56deg, transparent 64deg, transparent 360deg);
        -webkit-mask: radial-gradient(circle, transparent 56%, black 64%);
        mask: radial-gradient(circle, transparent 56%, black 64%);
    }
    .comet {
        position: absolute;
        top: -3px; left: 50%;
        width: 6px; height: 6px;
        margin-left: -3px;
        background: radial-gradient(circle, #ffffff 30%, rgba(220,220,240,0.6) 70%, transparent 100%);
        border-radius: 50%;
        box-shadow: 0 0 4px 1px rgba(255,255,255,0.9), 0 0 8px 2px rgba(220,220,255,0.6);
    }
    @keyframes comet-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes comet-fade { 0%,100% { opacity: 0.7; } 50% { opacity: 1; } }

    .related-product-card .sale-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-left: 6px;
    }
    .related-product-card .original-price {
        font-size: 0.9rem;
        color: #999;
        text-decoration: line-through;
        margin-bottom: 0;
    }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product_listing' %}">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- Product Details -->
    <div class="row">
        <!-- Product Gallery -->
        <div class="col-md-6">
            <div class="product-gallery">
                <div class="product-image-container img-magnifier-container">
                    <img src="{{ product.images.first.image }}" class="product-image" id="mainImage" alt="{{ product.name }}">
                    <button class="image-nav-button prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="image-nav-button next" onclick="changeImage(1)">&#10095;</button>
                </div>
                <div class="thumbnail-gallery" id="thumbnailGallery">
                    {% for image in product.images.all %}
                    <img src="{{ image.image }}" class="thumbnail {% if forloop.first %}active{% endif %}" 
                         alt="Product thumbnail" onclick="setActiveImage({{ forloop.counter0 }})">
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                <div class="product-rating">
                    <!-- Dummy 4-star rating -->
                    <span class="star">★</span>
                    <span class="star">★</span>
                    <span class="star">★</span>
                    <span class="star">★</span>
                    <span class="star empty">☆</span>
                    <span class="review-count">({{ review_count|default:42 }} reviews)</span>
                </div>

                {% if offer_type %}
                <div class="offer-type-badge">
                    <i class="fas fa-tag"></i>
                    <span class="offer-label">{{ offer_type }}</span>
                    <span class="offer-pct-val">{{ offer_percentage }}% OFF</span>
                </div>
                {% endif %}

                <div class="sale-price" id="salePrice">₹{{ product.variants.first.sale_price }}</div>
                <div class="original-price" id="actualPrice">₹{{ product.variants.first.actual_price }}</div>
                
                <!-- Variant Selection -->
                <div class="variant-select">
                    <div class="mb-3">
                        <label for="sizeSelect" class="form-label">Select Size</label>
                        <select class="form-select" id="sizeSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="colorSelect" class="form-label">Select Color</label>
                        <select class="form-select" id="colorSelect"></select>
                    </div>
                </div>
    
                <!-- Add to Cart Buttons -->
                <div class="d-flex align-items-center mb-3">
                    {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'add_to_cart' product.id %}" class="d-flex w-100 gap-2" id="addToCartForm">
                            {% csrf_token %}
                            <input type="hidden" name="variant" id="variantId" value="{{ product.variants.first.id }}">
                            <input type="hidden" name="quantity" value="1">
                            <div class="w-100 d-flex gap-2" id="productActions">
                            </div>
                            <button type="button" class="wishlist-btn" id="wishlistBtn"
                                    data-product-id="{{ product.id }}" 
                                    onclick="toggleWishlist(this, '{{ product.variants.first.size }}')">
                                <i class="fas fa-heart"></i>
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-warning d-flex justify-content-center align-items-center w-100" role="alert">
                            <span>Please <a href="{% url 'login_to_account' %}" class="btn btn-warning btn-sm">login</a> to add products to purchase.</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Description -->
                <div class="description">
                    <h5>Description</h5>
                    <p>{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- You May Also Like Section -->
    <section class="related-products">
        <h2>You May Also Like</h2>
        <div class="row row-cols-2 row-cols-md-4 g-4">
            {% for related_product in related_products %}
            <div class="col">
                <div class="card related-product-card h-100">
                    <a href="{% url 'product_detail' related_product.id %}" class="text-decoration-none">
                        <!-- Image wrapper with offer badge -->
                        <div style="position:relative; overflow:visible;">
                            {% if related_product.offer_percentage > 0 %}
                            <div class="offer-badge" style="position:absolute;top:-6px;right:-6px;z-index:10;width:48px;height:48px;pointer-events:none;filter:drop-shadow(0 0 6px rgba(255,255,255,0.7));animation:flower-pop 2s ease-in-out infinite;">
                                <div class="flower-petal"></div>
                                <div class="flower-petal"></div>
                                <div class="flower-petal"></div>
                                <div class="flower-petal"></div>
                                <div class="flower-petal"></div>
                                <div class="offer-text">
                                    <span class="offer-pct">{{ related_product.offer_percentage }}%</span>
                                    <span class="offer-off">OFF</span>
                                </div>
                                <div class="comet-orbit"><div class="comet"></div></div>
                            </div>
                            {% endif %}
                            <img src="{{ related_product.images.first.image }}" class="card-img-top" alt="{{ related_product.name }}">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ related_product.name|truncatechars:20 }}</h5>
                            <div class="product-rating">
                                {% with ''|center:5 as range %}
                                {% for _ in range %}
                                    {% if forloop.counter <= related_product.avg_rating %}
                                        <span class="star">★</span>
                                    {% else %}
                                        <span class="star empty">☆</span>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                                <span class="review-count">({{ related_product.review_count|default:0 }})</span>
                            </div>
                            <!-- Price display matching home page -->
                            {% with variant=related_product.variants.first %}
                            <div class="d-flex align-items-center mt-2">
                                {% if related_product.offer_price %}
                                    <span class="original-price">₹{{ variant.sale_price }}</span>
                                    <span class="sale-price">₹{{ related_product.offer_price }}</span>
                                {% else %}
                                    <span class="original-price">₹{{ variant.actual_price }}</span>
                                    <span class="sale-price">₹{{ variant.sale_price }}</span>
                                {% endif %}
                            </div>
                            {% endwith %}
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>


    <!-- Customer Reviews Section -->
    <section class="reviews-section">
        <h2>Customer Reviews</h2>
        {% if reviews %}
            {% for review in reviews %}
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-author">
                            {% if user.is_authenticated and review.user == user %}
                                You
                                <span style="font-size:0.75rem; color:#28a745; font-weight:600; background:#e8f5e9; padding:2px 8px; border-radius:12px; margin-left:6px;">Your Review</span>
                            {% else %}
                                {{ review.user.name|default:review.user.username|default:"Anonymous" }}
                            {% endif %}
                        </span>
                        <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                    </div>
                    <div class="review-rating">
                        {% with ''|center:5 as range %}
                        {% for _ in range %}
                            {% if forloop.counter <= review.rating %}
                                <span class="star">★</span>
                            {% else %}
                                <span class="star empty">☆</span>
                            {% endif %}
                        {% endfor %}
                        {% endwith %}
                        <span style="font-size:0.85rem; color:#666; margin-left:5px;">({{ review.rating }}/5)</span>
                    </div>
                    {% if review.title %}
                        <h5 class="review-title">{{ review.title }}</h5>
                    {% endif %}
                    <p>{{ review.comment }}</p>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-star-half-alt" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                <h4>No reviews yet</h4>
                <p class="text-muted">Be the first to review this product!</p>
            </div>
        {% endif %}
    </section>
</div>

<script>
let currentImageIndex = 0;
let images = [];
const availableVariants = {{ available_variants|safe }};
let currentSize = null;
let currentColor = null;

function checkWishlistStatus() {
    const productId = document.getElementById('wishlistBtn').dataset.productId;
    const size = currentSize || document.getElementById('sizeSelect').value;
    const color = currentColor || document.getElementById('colorSelect').value;
    
    // Build URL with size and color parameters
    let url = `/userpanel/is-wishlisted/${productId}/`;
    const params = new URLSearchParams();
    if (size) params.append('size', size);
    if (color) params.append('color', color);
    if (params.toString()) url += '?' + params.toString();
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        const wishlistBtn = document.getElementById('wishlistBtn');
        if (data.is_wishlisted) {
            wishlistBtn.classList.add('active');
        } else {
            wishlistBtn.classList.remove('active');
        }
    })
    .catch(error => {
        console.error('Error checking wishlist status:', error);
    });
}

function initializeImages() {
    images = Array.from(document.querySelectorAll('#thumbnailGallery img')).map(img => img.src);
    updateGallery();
}

function updateImages() {
    const variant = availableVariants.find(v => v.size === currentSize && v.color === currentColor);
    if (variant && variant.images && variant.images.length > 0) {
        images = variant.images;
    } else {
        initializeImages();
    }
    currentImageIndex = 0;
    updateGallery();
}

function updateGallery() {
    const mainImage = document.getElementById('mainImage');
    const thumbnailGallery = document.getElementById('thumbnailGallery');

    mainImage.src = images[currentImageIndex];
    // Refresh only the background src/size – don't recreate the glass
    if (typeof refreshMagnifier === 'function') refreshMagnifier();

    thumbnailGallery.innerHTML = '';
    images.forEach((image, index) => {
        const thumbnail = document.createElement('img');
        thumbnail.src = image;
        thumbnail.className = `thumbnail ${index === currentImageIndex ? 'active' : ''}`;
        thumbnail.alt = "Product thumbnail";
        thumbnail.onclick = () => setActiveImage(index);
        thumbnailGallery.appendChild(thumbnail);
    });
}

function setActiveImage(index) {
    currentImageIndex = index;
    updateGallery();
}

function changeImage(direction) {
    currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
    updateGallery();
}

function toggleWishlist(button, initialSize) {
    const productId = button.dataset.productId;
    const productSize = document.getElementById('sizeSelect').value || initialSize;
    const productColor = document.getElementById('colorSelect').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const formData = new FormData();
    formData.append('color', productColor);

    fetch(`/userpanel/toggle-wishlist/${productId}/${productSize}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Toggle the active class based on the message
            if (data.message.includes('added')) {
                button.classList.add('active');
            } else if (data.message.includes('removed')) {
                button.classList.remove('active');
            }
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message || 'Error adding to wishlist', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

function updateSizeOptions() {
    const sizeSelect = document.getElementById('sizeSelect');
    const availableSizes = [...new Set(availableVariants.map(v => v.size))];
    
    sizeSelect.innerHTML = '';
    availableSizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size;
        option.textContent = size;
        sizeSelect.appendChild(option);
    });
    
    if (currentSize && availableSizes.includes(currentSize)) {
        sizeSelect.value = currentSize;
    } else {
        currentSize = availableSizes[0];
        sizeSelect.value = currentSize;
    }
}

function updateColorOptions() {
    const colorSelect = document.getElementById('colorSelect');
    const availableColors = [...new Set(availableVariants.filter(v => v.size === currentSize).map(v => v.color))];
    
    colorSelect.innerHTML = '';
    availableColors.forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = color;
        colorSelect.appendChild(option);
    });
    
    if (currentColor && availableColors.includes(currentColor)) {
        colorSelect.value = currentColor;
    } else {
        currentColor = availableColors[0];
        colorSelect.value = currentColor;
    }
}

function updateVariantDetails() {
    const variant = availableVariants.find(v => v.size === currentSize && v.color === currentColor);
    const productActions = document.getElementById('productActions');
    
    if (variant) {
        // If offer exists, show offer_price highlighted (cutting sale_price)
        // If no offer, show sale_price highlighted (cutting actual_price/MRP)
        if (variant.offer_price) {
            document.getElementById('salePrice').textContent = `₹${variant.offer_price}`;
            document.getElementById('actualPrice').textContent = `₹${variant.sale_price}`;
        } else {
            document.getElementById('salePrice').textContent = `₹${variant.sale_price}`;
            document.getElementById('actualPrice').textContent = `₹${variant.actual_price}`;
        }
        document.getElementById('variantId').value = variant.id;

        productActions.innerHTML = '';

        if (parseInt(variant.quantity) > 0) {
            productActions.innerHTML = `
                <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="addToCartBtn">Add to Cart</button>
            `;
        } else {
            productActions.innerHTML = `
                <div class="out-of-stock w-100 text-center py-2 px-3 rounded">
                    Out of Stock
                </div>
            `;
        }
    } else {
        console.error('Variant not found');
        productActions.innerHTML = `
            <div class="out-of-stock w-100 text-center py-2 px-3 rounded">
                Variant Not Available
            </div>
        `;
    }
    updateImages();
    
    // Update wishlist button status for the new variant
    {% if user.is_authenticated %}
        checkWishlistStatus();
    {% endif %}
}

function handleSizeChange() {
    currentSize = document.getElementById('sizeSelect').value;
    updateColorOptions();
    updateVariantDetails();
}

function handleColorChange() {
    currentColor = document.getElementById('colorSelect').value;
    updateVariantDetails();
}

document.getElementById('sizeSelect').addEventListener('change', handleSizeChange);
document.getElementById('colorSelect').addEventListener('change', handleColorChange);

document.addEventListener('DOMContentLoaded', function() {
    // Read URL parameters for pre-selecting variant
    const urlParams = new URLSearchParams(window.location.search);
    const urlSize = urlParams.get('size');
    const urlColor = urlParams.get('color');
    
    // Pre-set size and color from URL if available
    if (urlSize) {
        const availableSizes = [...new Set(availableVariants.map(v => v.size))];
        const matchedSize = availableSizes.find(s => s == urlSize);
        if (matchedSize !== undefined) {
            currentSize = matchedSize;
        }
    }
    
    if (urlColor) {
        const decodedColor = decodeURIComponent(urlColor).toLowerCase();
        // Since we may need to select a color, we should ideally check against colors
        // available for the currently selected size, or just trust the URL and set it.
        // updateColorOptions() will reset it if invalid. Let's just set the matched color:
        const availableColors = [...new Set(availableVariants.map(v => v.color))];
        const matchedColor = availableColors.find(c => c.toLowerCase() === decodedColor);
        if (matchedColor !== undefined) {
            currentColor = matchedColor;
        }
    }
    
    initializeImages();
    updateSizeOptions();
    updateColorOptions();
    updateVariantDetails();
    updateGallery();
    
    // Check wishlist status for authenticated users
    {% if user.is_authenticated %}
        checkWishlistStatus();
    {% endif %}
    
    const addToCartForm = document.getElementById('addToCartForm');
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('addToCartBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Adding...';
                
                // Re-enable button after 3 seconds in case of issues
                setTimeout(() => {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Add to Cart';
                    }
                }, 3000);
            }
        });
    }
});

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

/* ── Magnifier (object-fit:contain aware) ── */
(function () {
    const ZOOM   = 2.5;   // magnification level
    const RADIUS = 65;    // lens radius in px
    const DIAM   = RADIUS * 2;

    let glass = null;
    let img   = null;

    /*
     * getRendered()
     * object-fit:contain leaves "letterbox" empty space.
     * getBoundingClientRect() gives the full <img> box.
     * We compute the actual drawn sub-rectangle inside it.
     */
    function getRendered() {
        const rect  = img.getBoundingClientRect();
        const elemW = rect.width;
        const elemH = rect.height;
        const natW  = img.naturalWidth  || elemW;
        const natH  = img.naturalHeight || elemH;

        const elemAspect = elemW / elemH;
        const natAspect  = natW  / natH;

        let rendW, rendH;
        if (natAspect > elemAspect) {
            rendW = elemW;
            rendH = elemW / natAspect;
        } else {
            rendH = elemH;
            rendW = elemH * natAspect;
        }

        return {
            rect,
            rendW,
            rendH,
            offsetX: (elemW - rendW) / 2,
            offsetY: (elemH - rendH) / 2
        };
    }

    function init() {
        img = document.getElementById('mainImage');
        if (!img) return;

        const old = img.parentElement.querySelector('.img-magnifier-glass');
        if (old) old.remove();

        glass = document.createElement('div');
        glass.className = 'img-magnifier-glass';
        glass.style.width  = DIAM + 'px';
        glass.style.height = DIAM + 'px';
        glass.style.backgroundRepeat = 'no-repeat';
        img.parentElement.appendChild(glass);

        // All events on IMAGE only — glass has pointer-events:none
        img.addEventListener('mouseenter', onEnter);
        img.addEventListener('mouseleave', onLeave);
        img.addEventListener('mousemove',  onMove);
    }

    function onEnter() { glass.style.display = 'block'; }
    function onLeave() { glass.style.display = 'none';  }

    function onMove(e) {
        e.preventDefault();
        const r = getRendered();

        // Cursor relative to the full element box
        const cx = e.clientX - r.rect.left;
        const cy = e.clientY - r.rect.top;

        // Cursor relative to the DRAWN image only (strip letterbox)
        const ix = cx - r.offsetX;
        const iy = cy - r.offsetY;

        // Hide when cursor is in empty letterbox area
        if (ix < 0 || iy < 0 || ix > r.rendW || iy > r.rendH) {
            glass.style.display = 'none';
            return;
        }
        glass.style.display = 'block';

        /*
         * background-size = rendW*ZOOM × rendH*ZOOM
         * This maps the shoe image (rendW × rendH CSS px) → (rendW*ZOOM × rendH*ZOOM px).
         * There is NO letterbox in the background image itself.
         *
         * So in background coords:
         *   the cursor point (ix, iy) → pixel (ix*ZOOM, iy*ZOOM)
         *
         * We want that pixel at position (RADIUS, RADIUS) inside the glass:
         *   background-position-x + ix*ZOOM = RADIUS
         *   → bx = RADIUS - ix*ZOOM
         *   (offsetX does NOT appear here — it's already stripped in ix)
         */
        const bgW = r.rendW * ZOOM;
        const bgH = r.rendH * ZOOM;

        glass.style.backgroundImage  = "url('" + img.src + "')";
        glass.style.backgroundSize   = bgW + 'px ' + bgH + 'px';

        const bx = RADIUS - ix * ZOOM;
        const by = RADIUS - iy * ZOOM;
        glass.style.backgroundPosition = bx + 'px ' + by + 'px';

        // Position glass centred on cursor (relative to container)
        glass.style.left = (cx - RADIUS) + 'px';
        glass.style.top  = (cy - RADIUS) + 'px';
    }

    // Called after src change
    window.refreshMagnifier = function () {
        if (!img || !glass) { init(); return; }
        // background-size is now set in onMove, nothing to pre-compute
        // Just update the src reference if needed
        if (glass) glass.style.backgroundImage = "url('" + img.src + "')";
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
}());
</script>
{% endblock %}
</merged_code>
