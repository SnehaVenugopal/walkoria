{% extends 'admin_base.html' %}
{% block title %}Dashboard | Walkoria Admin{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* ── Google Font ── */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

* { font-family: 'Inter', sans-serif; }

/* ── Period Filter Bar ── */
.period-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
    flex-wrap: wrap;
    gap: 12px;
}
.period-bar h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #7f8c8d;
    margin: 0;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}
.period-tabs {
    display: flex;
    gap: 6px;
    background: white;
    border-radius: 12px;
    padding: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.07);
}
.period-tabs a {
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #7f8c8d;
    text-decoration: none;
    transition: all 0.2s;
}
.period-tabs a.active, .period-tabs a:hover {
    background: var(--primary-color);
    color: white;
}

/* ── Ledger Download Button ── */
.ledger-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 9px 20px;
    background: linear-gradient(135deg,#2c3e50,#34495e);
    color: white;
    border-radius: 10px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 3px 10px rgba(44,62,80,0.3);
}
.ledger-btn:hover {
    background: linear-gradient(135deg,#1a252f,#2c3e50);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(44,62,80,0.4);
}

/* ── KPI Cards ── */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(6,1fr);
    gap: 16px;
    margin-bottom: 28px;
}
@media(max-width:1200px){ .kpi-grid{ grid-template-columns:repeat(3,1fr); } }
@media(max-width:768px){  .kpi-grid{ grid-template-columns:repeat(2,1fr); } }

.kpi-card {
    background: white;
    border-radius: 16px;
    padding: 22px 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}
.kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 28px rgba(0,0,0,0.12); }
.kpi-card::after {
    content:'';
    position:absolute;
    top:-20px;right:-20px;
    width:80px;height:80px;
    border-radius:50%;
    opacity:.08;
    background: var(--kpi-color,#ff429d);
}
.kpi-icon {
    width:42px;height:42px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    font-size:1.1rem;color:white;
    background: var(--kpi-color,#ff429d);
    box-shadow: 0 4px 12px rgba(0,0,0,0.18);
}
.kpi-label { font-size:11px;font-weight:600;color:#adb5bd;text-transform:uppercase;letter-spacing:0.6px; }
.kpi-value { font-size:1.6rem;font-weight:800;color:#2c3e50;line-height:1; }
.kpi-sub { font-size:11px;color:#7f8c8d; }

/* ── Dashboard main grid ── */
.dash-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 22px;
    margin-bottom: 22px;
}
@media(max-width:992px){ .dash-grid{ grid-template-columns:1fr; } }

/* ── Cards ── */
.dash-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
}
.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}
.card-title {
    font-size: 1rem;
    font-weight: 700;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
}
.card-title i { color: var(--primary-color); }

/* ── Chart container ── */
.chart-wrap { height: 280px; position: relative; }

/* ── Recent orders ── */
.order-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid #f1f3f5;
    text-decoration: none;
    transition: background 0.15s;
}
.order-item:last-child { border-bottom: none; }
.order-item:hover { background: #fafbfc; margin: 0 -12px; padding: 10px 12px; border-radius: 8px; }
.order-avatar {
    width: 36px;height: 36px;border-radius: 50%;
    background: linear-gradient(135deg,var(--primary-color),#764ba2);
    display: flex;align-items: center;justify-content: center;
    color: white;font-weight: 700;font-size: 14px;flex-shrink:0;
}
.order-name { font-size: 13px;font-weight: 600;color: #2c3e50; }
.order-meta { font-size: 11px;color: #adb5bd; }
.order-amt  { font-size: 13px;font-weight: 700;color: #27ae60;margin-left:auto; }

/* ── 3-column leaderboard grid ── */
.top-grid {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 22px;
    margin-bottom: 22px;
}
@media(max-width:992px){ .top-grid{ grid-template-columns:1fr 1fr; } }
@media(max-width:600px){ .top-grid{ grid-template-columns:1fr; } }

/* ── Top-N rank list ── */
.rank-list { display:flex;flex-direction:column;gap:10px; }
.rank-item {
    display:flex;align-items:center;gap:12px;
    padding:10px 12px;border-radius:10px;
    background:#f8f9fa;transition:background 0.2s;
}
.rank-item:hover { background:#f0f3ff; }
.rank-num {
    width:26px;height:26px;border-radius:8px;
    background:var(--primary-color);color:white;
    font-size:11px;font-weight:800;
    display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.rank-num.gold   { background: linear-gradient(135deg,#f6d365,#fda085); }
.rank-num.silver { background: linear-gradient(135deg,#bdc3c7,#95a5a6); }
.rank-num.bronze { background: linear-gradient(135deg,#c8955a,#a07040); }
.rank-info { flex:1; min-width:0; }
.rank-name { font-size:13px;font-weight:600;color:#2c3e50;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.rank-qty  { font-size:11px;color:#7f8c8d; }
.rank-rev  { font-size:12px;font-weight:700;color:#27ae60; }

/* bar chart mini canvas */
.mini-chart-wrap { height: 160px; position:relative; margin-top:12px; }

/* ── Chart type toggle ── */
.chart-type-btn {
    display:inline-flex;align-items:center;gap:6px;
    padding:5px 12px;border-radius:8px;border:1px solid #e9ecef;
    background:white;font-size:12px;font-weight:600;color:#6c757d;
    cursor:pointer;transition:all 0.2s;
}
.chart-type-btn.active, .chart-type-btn:hover {
    background:var(--primary-color);color:white;border-color:var(--primary-color);
}
</style>
{% endblock %}

{% block content %}

<!-- ── Period Selector ── -->
<div class="period-bar">
    <h2><i class="fas fa-tachometer-alt" style="color:var(--primary-color);"></i> &nbsp;Overview</h2>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div class="period-tabs">
            <a href="?period=daily"   class="{% if period == 'daily'   %}active{% endif %}">Today</a>
            <a href="?period=weekly"  class="{% if period == 'weekly'  %}active{% endif %}">Week</a>
            <a href="?period=monthly" class="{% if period == 'monthly' or not period %}active{% endif %}">Month</a>
            <a href="?period=yearly"  class="{% if period == 'yearly'  %}active{% endif %}">Year</a>
        </div>
        <a href="{% url 'download_ledger' %}?period={{ period }}" class="ledger-btn" target="_blank">
            <i class="fas fa-book"></i> Download Ledger PDF
        </a>
    </div>
</div>

<!-- ── KPI Cards ── -->
<div class="kpi-grid">
    <div class="kpi-card" style="--kpi-color:#ff429d;">
        <div class="kpi-icon"><i class="fas fa-rupee-sign"></i></div>
        <div class="kpi-label">Revenue</div>
        <div class="kpi-value">₹{{ total_revenue|floatformat:0 }}</div>
        <div class="kpi-sub">This period</div>
    </div>
    <div class="kpi-card" style="--kpi-color:#3498db;">
        <div class="kpi-icon"><i class="fas fa-shopping-bag"></i></div>
        <div class="kpi-label">Orders</div>
        <div class="kpi-value">{{ total_orders }}</div>
        <div class="kpi-sub">This period</div>
    </div>
    <div class="kpi-card" style="--kpi-color:#27ae60;">
        <div class="kpi-icon"><i class="fas fa-users"></i></div>
        <div class="kpi-label">Total Users</div>
        <div class="kpi-value">{{ total_users }}</div>
        <div class="kpi-sub">All time</div>
    </div>
    <div class="kpi-card" style="--kpi-color:#9b59b6;">
        <div class="kpi-icon"><i class="fas fa-user-plus"></i></div>
        <div class="kpi-label">New Users</div>
        <div class="kpi-value">{{ new_users }}</div>
        <div class="kpi-sub">This period</div>
    </div>
    <div class="kpi-card" style="--kpi-color:#e67e22;">
        <div class="kpi-icon"><i class="fas fa-clock"></i></div>
        <div class="kpi-label">Pending Orders</div>
        <div class="kpi-value">{{ pending_orders }}</div>
        <div class="kpi-sub">Awaiting action</div>
    </div>
    <div class="kpi-card" style="--kpi-color:#1abc9c;">
        <div class="kpi-icon"><i class="fas fa-boxes"></i></div>
        <div class="kpi-label">Products</div>
        <div class="kpi-value">{{ total_products }}</div>
        <div class="kpi-sub">Active listings</div>
    </div>
</div>

<!-- ── Sales Chart + Recent Orders ── -->
<div class="dash-grid">
    <!-- Sales Chart -->
    <div class="dash-card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                Sales Overview
                <span style="font-size:11px;color:#adb5bd;font-weight:400;">
                    — {% if period == 'daily' %}Today by hour{% elif period == 'weekly' %}Last 7 days{% elif period == 'yearly' %}By month{% else %}This month{% endif %}
                </span>
            </div>
            <div style="display:flex;gap:6px;">
                <button class="chart-type-btn active" id="btnBar" onclick="setChartType('bar')">
                    <i class="fas fa-chart-bar"></i> Bar
                </button>
                <button class="chart-type-btn" id="btnLine" onclick="setChartType('line')">
                    <i class="fas fa-chart-line"></i> Line
                </button>
            </div>
        </div>
        <div class="chart-wrap">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="dash-card">
        <div class="card-header">
            <div class="card-title"><i class="fas fa-receipt"></i> Recent Orders</div>
            <a href="{% url 'orders' %}" style="font-size:12px;color:var(--primary-color);text-decoration:none;font-weight:600;">
                View all <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        {% for sale in recent_sales %}
        <a href="{% url 'admin_order_overview' sale.id %}" class="order-item">
            <div class="order-avatar">{{ sale.customer_name.0|upper }}</div>
            <div>
                <div class="order-name">{{ sale.customer_name|title }}</div>
                <div class="order-meta">{{ sale.created_at|timesince }} ago · #{{ sale.order_number }}</div>
            </div>
            <div class="order-amt">₹{{ sale.total_amount|floatformat:0 }}</div>
        </a>
        {% empty %}
        <div style="text-align:center;padding:30px;color:#adb5bd;">
            <i class="fas fa-inbox" style="font-size:2rem;display:block;margin-bottom:10px;"></i>
            No recent orders
        </div>
        {% endfor %}
    </div>
</div>

<!-- ── Top 10 Leaderboards ── -->
<div class="top-grid">

    <!-- Top Products -->
    <div class="dash-card">
        <div class="card-header">
            <div class="card-title"><i class="fas fa-medal"></i> Top 10 Products</div>
        </div>
        <!-- mini bar chart -->
        <div class="mini-chart-wrap">
            <canvas id="productChart"></canvas>
        </div>
        <!-- rank list -->
        <div class="rank-list" style="margin-top:16px;">
            {% for p in top_products %}
            <div class="rank-item">
                <div class="rank-num {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="rank-info">
                    <div class="rank-name">{{ p.product_name }}</div>
                    <div class="rank-qty">{{ p.total_qty }} units sold</div>
                </div>
                <div class="rank-rev">₹{{ p.total_rev|floatformat:0 }}</div>
            </div>
            {% empty %}
            <div style="text-align:center;padding:20px;color:#adb5bd;font-size:13px;">No data yet</div>
            {% endfor %}
        </div>
    </div>

    <!-- Top Categories -->
    <div class="dash-card">
        <div class="card-header">
            <div class="card-title"><i class="fas fa-th-large"></i> Top 10 Categories</div>
        </div>
        <div class="mini-chart-wrap">
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="rank-list" style="margin-top:16px;">
            {% for c in top_categories %}
            <div class="rank-item">
                <div class="rank-num {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="rank-info">
                    <div class="rank-name">{{ c.cat_name }}</div>
                    <div class="rank-qty">{{ c.total_qty }} units sold</div>
                </div>
                <div class="rank-rev">₹{{ c.total_rev|floatformat:0 }}</div>
            </div>
            {% empty %}
            <div style="text-align:center;padding:20px;color:#adb5bd;font-size:13px;">No data yet</div>
            {% endfor %}
        </div>
    </div>

    <!-- Top Brands -->
    <div class="dash-card">
        <div class="card-header">
            <div class="card-title"><i class="fas fa-tags"></i> Top 10 Brands</div>
        </div>
        <div class="mini-chart-wrap">
            <canvas id="brandChart"></canvas>
        </div>
        <div class="rank-list" style="margin-top:16px;">
            {% for b in top_brands %}
            <div class="rank-item">
                <div class="rank-num {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="rank-info">
                    <div class="rank-name">{{ b.brand_name }}</div>
                    <div class="rank-qty">{{ b.total_qty }} units sold</div>
                </div>
                <div class="rank-rev">₹{{ b.total_rev|floatformat:0 }}</div>
            </div>
            {% empty %}
            <div style="text-align:center;padding:20px;color:#adb5bd;font-size:13px;">No data yet</div>
            {% endfor %}
        </div>
    </div>

</div>

{% endblock %}

{% block extra_scripts %}
<script>
// ── Data from Django ──────────────────────────────────────────────────────
const CHART_LABELS  = {{ chart_labels|safe }};
const CHART_DATA    = {{ chart_data|safe   }};

const PRODUCT_LABELS  = {{ top_product_labels|safe  }};
const PRODUCT_DATA    = {{ top_product_data|safe    }};
const CATEGORY_LABELS = {{ top_category_labels|safe }};
const CATEGORY_DATA   = {{ top_category_data|safe   }};
const BRAND_LABELS    = {{ top_brand_labels|safe    }};
const BRAND_DATA      = {{ top_brand_data|safe      }};

// ── Palette helpers ───────────────────────────────────────────────────────
const PINK_GRADIENT_PALETTE = [
    '#ff429d','#e63384','#c9215f','#ff6ab4','#ff8eca',
    '#d63af9','#9b59b6','#764ba2','#3498db','#1abc9c'
];

function makeGradient(ctx, color1, color2) {
    const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight || 280);
    g.addColorStop(0, color1);
    g.addColorStop(1, color2);
    return g;
}

// ── Main Sales Chart ─────────────────────────────────────────────────────
const salesCtx = document.getElementById('salesChart').getContext('2d');
let currentType = 'bar';
let salesChart;

function buildSalesChart(type) {
    if (salesChart) salesChart.destroy();

    const gradient = salesCtx.createLinearGradient(0, 0, 0, 280);
    gradient.addColorStop(0, 'rgba(255,66,157,0.85)');
    gradient.addColorStop(1, 'rgba(255,66,157,0.15)');

    salesChart = new Chart(salesCtx, {
        type: type,
        data: {
            labels: CHART_LABELS,
            datasets: [{
                label: 'Revenue (₹)',
                data: CHART_DATA,
                backgroundColor: type === 'bar' ? gradient : 'rgba(255,66,157,0.1)',
                borderColor: '#ff429d',
                borderWidth: type === 'bar' ? 0 : 2.5,
                borderRadius: type === 'bar' ? 6 : 0,
                borderSkipped: false,
                fill: type === 'line',
                tension: 0.4,
                pointBackgroundColor: '#ff429d',
                pointRadius: type === 'line' ? 4 : 0,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 600, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false },
                    ticks: {
                        color: '#adb5bd', font: { size: 11 },
                        callback: v => '₹' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v)
                    },
                    border: { display: false }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#adb5bd', font: { size: 10 }, maxRotation: 45 }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#2c3e50',
                    titleColor: '#ecf0f1',
                    bodyColor: '#bdc3c7',
                    padding: 12,
                    cornerRadius: 10,
                    callbacks: {
                        label: ctx => ' ₹' + ctx.parsed.y.toFixed(2)
                    }
                }
            }
        }
    });
}

function setChartType(type) {
    currentType = type;
    buildSalesChart(type);
    document.getElementById('btnBar').classList.toggle('active', type === 'bar');
    document.getElementById('btnLine').classList.toggle('active', type === 'line');
}

buildSalesChart('bar');

// ── Mini Horizontal Bar Charts ────────────────────────────────────────────
function buildMiniChart(canvasId, labels, data, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const barColors = labels.map((_, i) => PINK_GRADIENT_PALETTE[i % PINK_GRADIENT_PALETTE.length]);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: barColors,
                borderRadius: 5,
                barThickness: 12,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutBounce' },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.04)' },
                    ticks: { color: '#adb5bd', font: { size: 10 } },
                    border: { display: false }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        color: '#5d6778', font: { size: 10 }, maxRotation: 0,
                        callback: v => v.length > 12 ? v.slice(0,12)+'…' : v
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#2c3e50',
                    callbacks: { label: ctx => ' ' + ctx.parsed.x + ' units' }
                }
            }
        }
    });
}

buildMiniChart('productChart',  PRODUCT_LABELS,  PRODUCT_DATA,  '#ff429d');
buildMiniChart('categoryChart', CATEGORY_LABELS, CATEGORY_DATA, '#9b59b6');
buildMiniChart('brandChart',    BRAND_LABELS,    BRAND_DATA,    '#3498db');
</script>
{% endblock %}
