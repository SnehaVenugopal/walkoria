{% extends 'admin_base.html' %}

{% block title %}Wallet Management | Walkoria{% endblock %}
{% block page_title %}Wallet Management{% endblock %}

{% block extra_css %}
<style>
    /* ── Summary Cards ── */
    .wallet-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .stat-icon.total   { background: #e8f4fd; color: #3498db; }
    .stat-icon.credit  { background: #eafaf1; color: #27ae60; }
    .stat-icon.debit   { background: #fdf0f0; color: #e74c3c; }

    .stat-info h3 {
        font-size: 1.6rem;
        font-weight: 700;
        margin: 0 0 4px;
        color: #2c3e50;
    }

    .stat-info p {
        margin: 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    /* ── Filter Bar ── */
    .filter-bar {
        background: white;
        border-radius: 12px;
        padding: 20px 25px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.07);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-bar input,
    .filter-bar select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
        background: #fafafa;
    }

    .filter-bar input:focus,
    .filter-bar select:focus {
        outline: none;
        border-color: var(--primary-color);
        background: white;
    }

    .filter-bar input { width: 280px; }
    .filter-bar select { width: 160px; }

    .btn-filter {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .btn-search { background: var(--primary-color); color: white; }
    .btn-search:hover { background: #e63384; color: white; }
    .btn-clear  { background: #6c757d; color: white; }
    .btn-clear:hover { background: #5a6268; color: white; }

    /* ── Table ── */
    .table-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        overflow-x: auto;
    }

    .wallet-table {
        width: 100%;
        border-collapse: collapse;
    }

    .wallet-table th,
    .wallet-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid #f1f3f5;
    }

    .wallet-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .wallet-table tbody tr:hover { background: #fafbfc; }

    .wallet-table td { font-size: 14px; color: #495057; }

    /* ── Badges ── */
    .badge-type {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-credit { background: #eafaf1; color: #1e8449; }
    .badge-debit  { background: #fdf0f0; color: #c0392b; }

    .badge-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-status.completed { background: #d4edda; color: #155724; }
    .badge-status.pending   { background: #fff3cd; color: #856404; }
    .badge-status.failed    { background: #f8d7da; color: #721c24; }

    /* source chip */
    .source-chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
        background: #f0f4ff;
        color: #3a56b0;
        white-space: nowrap;
    }

    /* action button */
    .btn-view {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 7px 14px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }

    .btn-view:hover {
        background: #e63384;
        color: white;
        transform: translateY(-1px);
    }

    /* ── Pagination ── */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 25px;
    }

    .pagination {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        gap: 5px;
    }

    .page-link {
        display: block;
        padding: 8px 13px;
        border-radius: 6px;
        border: 1px solid #ddd;
        color: var(--primary-color);
        text-decoration: none;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .page-link:hover { background: #f8f9fa; }
    .page-item.active .page-link { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .page-item.disabled .page-link { color: #adb5bd; pointer-events: none; }

    .no-results {
        text-align: center;
        padding: 50px;
        color: #7f8c8d;
    }

    .no-results i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.4;
    }

    /* amount display */
    .amount-cr { color: #27ae60; font-weight: 600; }
    .amount-dr { color: #e74c3c; font-weight: 600; }
</style>
{% endblock %}

{% block content %}

<!-- Summary Stats -->
<div class="wallet-stats">
    <div class="stat-card">
        <div class="stat-icon total">
            <i class="fas fa-list-alt"></i>
        </div>
        <div class="stat-info">
            <h3>{{ total_transactions }}</h3>
            <p>Total Transactions</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon credit">
            <i class="fas fa-arrow-down"></i>
        </div>
        <div class="stat-info">
            <h3>₹{{ total_credits|floatformat:2 }}</h3>
            <p>Total Credits</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon debit">
            <i class="fas fa-arrow-up"></i>
        </div>
        <div class="stat-info">
            <h3>₹{{ total_debits|floatformat:2 }}</h3>
            <p>Total Debits</p>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <form method="GET" action="{% url 'admin_wallet_transactions' %}" style="display:flex; align-items:center; gap:15px; flex-wrap:wrap; width:100%;">
        <i class="fas fa-search" style="color:#aaa;"></i>
        <input type="text" name="search" placeholder="Search by Transaction ID, User, or Description…" value="{{ search_query }}">

        <select name="type">
            <option value="">All Types</option>
            <option value="Cr" {% if type_filter == 'Cr' %}selected{% endif %}>Credit</option>
            <option value="Dr" {% if type_filter == 'Dr' %}selected{% endif %}>Debit</option>
        </select>

        <select name="status">
            <option value="">All Status</option>
            <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
            <option value="Pending"   {% if status_filter == 'Pending'   %}selected{% endif %}>Pending</option>
            <option value="Failed"    {% if status_filter == 'Failed'    %}selected{% endif %}>Failed</option>
        </select>

        <button type="submit" class="btn-filter btn-search">
            <i class="fas fa-search"></i> Search
        </button>

        {% if search_query or type_filter or status_filter %}
        <a href="{% url 'admin_wallet_transactions' %}" class="btn-filter btn-clear">
            <i class="fas fa-times"></i> Clear
        </a>
        {% endif %}
    </form>
</div>

<!-- Transactions Table -->
<div class="table-card">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="padding:12px; margin-bottom:15px; border-radius:8px;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <table class="wallet-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Transaction ID</th>
                <th>Date &amp; Time</th>
                <th>User</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Source</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in transactions %}
            <tr>
                <td>{{ forloop.counter0|add:transactions.start_index }}</td>
                <td>
                    <code style="font-size:12px; color:#555;">{{ txn.transaction_id|default:"—" }}</code>
                </td>
                <td>
                    <div style="font-size:13px;">{{ txn.created_at|date:"M d, Y" }}</div>
                    <div style="font-size:11px; color:#aaa;">{{ txn.created_at|time:"h:i A" }}</div>
                </td>
                <td>
                    <div style="font-weight:600; color:#2c3e50;">{{ txn.wallet.user.name|title }}</div>
                    <div style="font-size:11px; color:#aaa;">{{ txn.wallet.user.email }}</div>
                </td>
                <td>
                    {% if txn.transaction_type == 'Cr' %}
                        <span class="badge-type badge-credit"><i class="fas fa-arrow-down"></i> Credit</span>
                    {% else %}
                        <span class="badge-type badge-debit"><i class="fas fa-arrow-up"></i> Debit</span>
                    {% endif %}
                </td>
                <td>
                    {% if txn.transaction_type == 'Cr' %}
                        <span class="amount-cr">+₹{{ txn.amount|floatformat:2 }}</span>
                    {% else %}
                        <span class="amount-dr">-₹{{ txn.amount|floatformat:2 }}</span>
                    {% endif %}
                </td>
                <td>
                    {% with tid=txn.transaction_id|default:"" %}
                        {% if "TXN-" in tid and txn.transaction_type == 'Cr' %}
                            <span class="source-chip"><i class="fas fa-plus-circle"></i> Wallet Topup</span>
                        {% elif "TXN-" in tid and txn.transaction_type == 'Dr' %}
                            <span class="source-chip"><i class="fas fa-shopping-bag"></i> Order Payment</span>
                        {% elif tid|slice:":2" == "RF" %}
                            <span class="source-chip"><i class="fas fa-undo-alt"></i> Cancel Refund</span>
                        {% elif tid|slice:":2" == "RT" %}
                            <span class="source-chip"><i class="fas fa-exchange-alt"></i> Return Refund</span>
                        {% elif tid|slice:":3" == "REF" %}
                            <span class="source-chip"><i class="fas fa-user-friends"></i> Referral</span>
                        {% else %}
                            <span class="source-chip"><i class="fas fa-wallet"></i> Other</span>
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <span class="badge-status {{ txn.status|lower }}">{{ txn.status }}</span>
                </td>
                <td>
                    <a href="{% url 'admin_wallet_transaction_detail' txn.id %}" class="btn-view">
                        <i class="fas fa-eye"></i> View
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">
                    <div class="no-results">
                        <i class="fas fa-wallet d-block"></i>
                        {% if search_query or type_filter or status_filter %}
                            No transactions found matching your criteria.
                        {% else %}
                            No wallet transactions found.
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if transactions.has_other_pages %}
    <div class="pagination-container">
        <ul class="pagination">
            {% if transactions.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-left"></i></span></li>
                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-left"></i></span></li>
            {% endif %}

            {% for num in transactions.paginator.page_range %}
                {% if transactions.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > transactions.number|add:'-3' and num < transactions.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if transactions.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-right"></i></span></li>
                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-right"></i></span></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>

{% endblock %}
