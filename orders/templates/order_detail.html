{% extends "base_userpanel.html" %}
{% load static %}
{% load status_filters %}
{% load order_filters %}

{% block title %}Order #{{ order.order_number }} - Walkoria{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/order_detail.css' %}">
{% endblock %}

{% block additional_styles %}
<style>
    :root {
        --primary-color: #ff429d;
        --secondary-color: #6c757d;
        --light-color: #f8f9fa;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
    }

    /* Clean white container for all content */
    .main-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    /* Breadcrumb styling inside white container */
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #6c757d;
    }

    /* Simplified order header */
    .order-header {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .order-number {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .order-date {
        font-size: 0.95rem;
        color: #6c757d;
    }

    /* Cleaner status badges */
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-weight: 500;
        font-size: 0.8rem;
        text-transform: capitalize;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-processing { background: #d1ecf1; color: #0c5460; }
    .status-shipped { background: #d4edda; color: #155724; }
    .status-delivered { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-returned { background: #e2e3e5; color: #383d41; }

    /* Simplified card design */
    .info-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .info-card h6 {
        color: #333;
        font-weight: 600;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .info-card p {
        margin-bottom: 0.5rem;
        color: #666;
        font-size: 0.9rem;
    }

    /* Product item styling */
    .product-item {
        border-bottom: 1px solid #e9ecef;
        padding: 1.5rem 0;
    }

    .product-item:last-child {
        border-bottom: none;
    }

    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .product-details h6 {
        color: #333;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .product-details p {
        margin-bottom: 0.3rem;
        color: #666;
        font-size: 0.85rem;
    }

    /* Cleaner button styling */
    .btn-custom {
        border-radius: 5px;
        padding: 0.4rem 0.8rem;
        font-weight: 500;
        font-size: 0.85rem;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        min-width: 100px;
        justify-content: center;
        margin-bottom: 0.5rem;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-custom:hover {
        background: #e63a8a;
        color: white;
    }

    .btn-secondary-custom {
        background: var(--secondary-color);
        color: white;
    }

    .btn-secondary-custom:hover {
        background: #5a6268;
        color: white;
    }

    .btn-cancel {
        background: var(--danger-color);
        color: red;
        border: 2px solid red;  
    }

    .btn-cancel:hover {
        background: #c82333;
        color: white;
    }

    .btn-return {
        background: var(--warning-color);
        color: #212529;
    }

    .btn-return:hover {
        background: #e0a800;
        color: #212529;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
    }

    /* Timeline styling */
    .timeline-item {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .timeline-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .timeline-icon.completed {
        background: var(--success-color);
        color: white;
    }

    .timeline-icon.pending {
        background: var(--warning-color);
        color: white;
    }

    @media (max-width: 768px) {
        .main-container {
            padding: 1rem;
        }
        
        .order-number {
            font-size: 1.4rem;
        }
        
        .action-buttons {
            align-items: stretch;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Main white container with breadcrumbs inside -->
    <div class="main-container">
        <!-- Breadcrumb inside white container -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'my_orders' %}">My Orders</a></li>
                <li class="breadcrumb-item active">Order #{{ order.order_number }}</li>
            </ol>
        </nav>

        <!-- Order Header -->
        <div class="order-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="order-number">Order #{{ order.order_number }}</div>
                    <div class="order-date">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Placed on {{ order.created_at|date:"F d, Y \a\t g:i A" }}
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="mb-2">
                        <span class="status-badge status-{{ order.get_overall_status|lower }}">
                            {{ order.get_overall_status|default:"Processing" }}
                        </span>
                    </div>
                    <div class="h4 mb-0">₹{{ order.total_amount }}</div>
                </div>
            </div>
        </div>

        <!-- Order Information Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-credit-card me-2"></i>Payment Information</h6>
                    <p><strong>Payment Method:</strong> {{ order.get_payment_method_display }}</p>
                    {% comment %} <p><strong>Payment Status:</strong>  {% endcomment %}
                        {% comment %} <span class="badge 
                            {% if order.payment_method == 'COD' and not order.payment_status %}bg-warning
                            {% elif order.payment_status %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {% if order.payment_method == 'COD' and not order.payment_status %}
                                Cash on Delivery
                            {% elif order.payment_status %}
                                Paid
                            {% else %}
                                Pending
                            {% endif %}
                        </span>
                    </p> {% endcomment %}
                    <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                    {% for item in order.items.all %}
                        {% if item.status == 'Returned' and item.item_payment_status == 'Refunded' and order.payment_method == 'COD' %}
                            <p><strong>Refunded Amount:</strong> ₹{{ item.price|floatformat:2 }}</p>
                        {% endif %}
                    {% endfor %}
                    
                    {% if order.payment_method == 'COD' and not order.payment_status %}
                        <div class="mt-3">
                            {% comment %} <a href="{% url 'razorpay_checkout' order.id %}" class="btn btn-custom btn-primary-custom"> {% endcomment %}
                                <i class="fas fa-credit-card me-2"></i>Complete Payment
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="info-card">
                    <h6><i class="fas fa-shipping-fast me-2"></i>Shipping Address</h6>
                    <p><strong>{{ order.shipping_address.full_name }}</strong></p>
                    <p>{{ order.shipping_address.street }}</p>
                    <p>{{ order.shipping_address.city }}, {{ order.shipping_address.state }}</p>
                    <p>PIN: {{ order.shipping_address.pin_code }}</p>
                    <p><i class="fas fa-phone me-1"></i> {{ order.shipping_address.mobile_no }}</p>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="info-card">
            <h6><i class="fas fa-box-open me-2"></i>Ordered Items ({{ order.items.count }})</h6>
            
            {% for item in order.items.all %}
                <div class="product-item">
                    <div class="row align-items-center">
                        <div class="col-md-2 col-sm-3 mb-3 mb-md-0">
                            <a href="{% url 'product_detail' item.product_variant.product.id %}">
                                {% if item.product_variant.product.images.first %}
                                    <img src="{{ item.product_variant.product.images.first.image }}" 
                                         alt="{{ item.product_variant.product.name }}" 
                                         class="product-image">
                                {% else %}
                                    <div class="product-image d-flex align-items-center justify-content-center bg-light">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                {% endif %}
                            </a>
                        </div>
                        
                        <div class="col-md-6 col-sm-9 mb-3 mb-md-0">
                            <div class="product-details">
                                <a href="{% url 'product_detail' item.product_variant.product.id %}" 
                                   class="text-decoration-none">
                                    <h6>{{ item.product_variant.product.name }}</h6>
                                </a>
                                <p><strong>Color:</strong> {{ item.product_variant.color }}</p>
                                <p><strong>Size:</strong> {{ item.product_variant.size }}</p>
                                <p><strong>Quantity:</strong> {{ item.quantity }}</p>
                                <p><strong>Price:</strong> ₹{{ item.price }} each</p>
                                <p><strong>Total:</strong> ₹{{ item.price|multiply:item.quantity }}</p>
                                <p><strong>Status:</strong> 
                                    <span class="status-badge status-{{ item.status|lower }}">
                                        {{ item.get_status_display }}
                                    </span>
                                </p>
                                {% if item.cancellation_reason %}
                                    <p><strong>Reason:</strong> {{ item.get_cancellation_reason_display }}</p>
                                {% endif %}
                                {% if item.custom_cancellation_reason %}
                                    <p><strong>Custom Reason:</strong> {{ item.custom_cancellation_reason }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="action-buttons">
                                {% if item.status == 'Delivered' %}
                                    <a href="{% url 'return_product' item.id %}" 
                                       class="btn btn-custom btn-return">
                                        <i class="fas fa-undo me-2"></i>Return Item
                                    </a>
                                    {% if order.payment_status or order.payment_method == 'COD' %}
                                        <a href="{% url 'download_invoice' order.id %}" 
                                           class="btn btn-custom btn-primary-custom">
                                            <i class="fas fa-file-invoice me-2"></i>Download Invoice
                                        </a>
                                    {% endif %}
                                    <button class="btn btn-custom btn-secondary-custom" 
                                            onclick="rateProduct({{ item.product_variant.product.id }})">
                                        <i class="fas fa-star me-2"></i>Rate Product
                                    </button>
                                {% elif item.status == 'Return_Requested' %}
                                    <span class="badge bg-warning p-2 mb-2">
                                        <i class="fas fa-clock me-1"></i>Return Requested
                                    </span>
                                    {% if order.payment_status or order.payment_method == 'COD' %}
                                        <a href="{% url 'download_invoice' item.id %}" 
                                           class="btn btn-custom btn-primary-custom">
                                            <i class="fas fa-file-invoice me-2"></i>Download Invoice
                                        </a>
                                    {% endif %}
                                {% elif item.status in 'Pending,Processing,On_Hold' %}
                                    {% if order.payment_status or order.payment_method == 'COD' %}
                                        <a href="{% url 'download_invoice' item.id %}" 
                                           class="btn btn-custom btn-primary-custom">
                                            <i class="fas fa-file-invoice me-2"></i>Download Invoice
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'cancel_product' item.id %}" 
                                       class="btn btn-custom btn-cancel">
                                        <i class="fas fa-times me-2"></i>Cancel Item
                                    </a>
                                {% elif item.status == 'Cancelled' %}
                                    <span class="badge bg-danger p-2">
                                        <i class="fas fa-times me-1"></i>Cancelled
                                    </span>
                                {% elif item.status == 'Returned' %}
                                    <span class="badge bg-info p-2">
                                        <i class="fas fa-undo me-1"></i>Returned
                                    </span>
                                {% else %}
                                    {% if order.payment_status or order.payment_method == 'COD' %}
                                        <a href="{% url 'download_invoice' item.id %}" 
                                           class="btn btn-custom btn-primary-custom">
                                            <i class="fas fa-file-invoice me-2"></i>Download Invoice
                                        </a>
                                    {% endif %}
                                    <span class="badge bg-secondary p-2">
                                        {{ item.get_status_display }}
                                    </span>
                                {% endif %}
                                                                {% if item.status == 'Delivered' %}
                                    {% if order.payment_status or order.payment_method == 'COD' %}
                                        <a href="{% url 'download_invoice' item.id %}" 
                                        class="btn btn-custom btn-primary-custom">
                                            <i class="fas fa-file-invoice me-2"></i>Download Invoice
                                        </a>
                                    {% endif %}
                                {% endif %}

                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Improved Order Timeline -->
        <div class="info-card mt-4">
            <h6><i class="fas fa-history me-2"></i>Order Timeline</h6>
            
            <div class="timeline">
                {% for item in order.items.all %}
                    {% if item.status != 'Pending' and forloop.first %}
                        <div class="timeline-item">
                            <div class="timeline-icon completed">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Order Placed</h6>
                                <p class="text-muted mb-0">{{ order.created_at|date:"F d, Y \a\t g:i A" }}</p>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                
                {% if order.payment_status %}
                    <div class="timeline-item">
                        <div class="timeline-icon completed">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Payment Confirmed</h6>
                            <p class="text-muted mb-0">{{ order.updated_at|date:"F d, Y \a\t g:i A" }}</p>
                        </div>
                    </div>
                {% endif %}
                
                {% for item in order.items.all %}
                    {% if item.status == 'Processing' %}
                        <div class="timeline-item">
                            <div class="timeline-icon pending">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Order Processing</h6>
                                <p class="text-muted mb-0">Your order is being prepared</p>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 10px; border: 1px solid #e9ecef;">
            <div class="modal-header" style="background: var(--light-color); border-bottom: 1px solid #e9ecef;">
                <h5 class="modal-title" id="ratingModalLabel" style="color: #333;">
                    <i class="fas fa-star me-2" style="color: var(--primary-color);"></i>Rate Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-4">
                <form id="ratingForm">
                    <input type="hidden" id="productId" name="productId">
                    <div class="mb-4">
                        <label for="rating" class="form-label fw-bold">Rating</label>
                        <div class="star-rating d-flex gap-2 mb-2" id="starRating" style="font-size: 2rem;">
                            <i class="far fa-star text-warning" data-rating="1" style="cursor: pointer;"></i>
                            <i class="far fa-star text-warning" data-rating="2" style="cursor: pointer;"></i>
                            <i class="far fa-star text-warning" data-rating="3" style="cursor: pointer;"></i>
                            <i class="far fa-star text-warning" data-rating="4" style="cursor: pointer;"></i>
                            <i class="far fa-star text-warning" data-rating="5" style="cursor: pointer;"></i>
                        </div>
                        <input type="hidden" id="rating" name="rating" required>
                        <div class="error-message text-danger" id="ratingError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label fw-bold">Review Title</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               placeholder="Summarize your review" required
                               style="border-radius: 10px; border: 2px solid #e9ecef;">
                        <div class="error-message text-danger" id="titleError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label fw-bold">Your Review</label>
                        <textarea class="form-control" id="comment" name="comment" rows="4" 
                                  placeholder="Share your experience with this product" required
                                  style="border-radius: 10px; border: 2px solid #e9ecef;"></textarea>
                        <div class="error-message text-danger" id="commentError"></div>
                    </div>
                </form>
            </div>

            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-custom btn-secondary-custom" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-custom btn-primary-custom" id="submitRating">
                    <i class="fas fa-paper-plane me-2"></i>Submit Review
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
    const starRating = document.getElementById('starRating');
    const ratingInput = document.getElementById('rating');
    const ratingForm = document.getElementById('ratingForm');
    const submitRatingBtn = document.getElementById('submitRating');

    window.rateProduct = function(productId) {
        document.getElementById('productId').value = productId;
        
        fetch(`{% url 'get_user_review' 0 %}`.replace('0', productId))
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    ratingInput.value = data.rating;
                    updateStars(data.rating);
                    document.getElementById('title').value = data.title;
                    document.getElementById('comment').value = data.comment;
                } else {
                    ratingForm.reset();
                    updateStars(0);
                }
                ratingModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                ratingForm.reset();
                updateStars(0);
                ratingModal.show();
            });
    }

    starRating.addEventListener('click', function(e) {
        if (e.target.classList.contains('fa-star')) {
            const rating = e.target.getAttribute('data-rating');
            ratingInput.value = rating;
            updateStars(rating);
        }
    });

    starRating.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('fa-star')) {
            const rating = e.target.getAttribute('data-rating');
            highlightStars(rating);
        }
    });

    starRating.addEventListener('mouseleave', function() {
        updateStars(ratingInput.value || 0);
    });

    function updateStars(rating) {
        const stars = starRating.querySelectorAll('.fa-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });
    }

    function highlightStars(rating) {
        const stars = starRating.querySelectorAll('.fa-star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.remove('far');
                star.classList.add('fas');
            } else {
                star.classList.remove('fas');
                star.classList.add('far');
            }
        });
    }

    submitRatingBtn.addEventListener('click', function() {
        if (validateForm()) {
            const formData = new FormData(ratingForm);
            
            submitRatingBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            submitRatingBtn.disabled = true;
            
            fetch('{% url "submit_rating" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thank You!',
                        text: data.message,
                        confirmButtonColor: '#ff429d'
                    });
                    ratingModal.hide();
                    ratingForm.reset();
                    updateStars(0);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Error submitting rating. Please try again.',
                        confirmButtonColor: '#ff429d'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'An error occurred. Please try again.',
                    confirmButtonColor: '#ff429d'
                });
            })
            .finally(() => {
                submitRatingBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Review';
                submitRatingBtn.disabled = false;
            });
        }
    });

    function validateForm() {
        let isValid = true;
        const rating = ratingInput.value;
        const title = document.getElementById('title').value;
        const comment = document.getElementById('comment').value;

        document.getElementById('ratingError').textContent = '';
        document.getElementById('titleError').textContent = '';
        document.getElementById('commentError').textContent = '';

        if (!rating) {
            document.getElementById('ratingError').textContent = 'Please select a rating.';
            isValid = false;
        }

        if (!title.trim()) {
            document.getElementById('titleError').textContent = 'Please enter a title.';
            isValid = false;
        }

        if (!comment.trim()) {
            document.getElementById('commentError').textContent = 'Please enter a comment.';
            isValid = false;
        }

        return isValid;
    }
});
</script>
{% endblock %}
